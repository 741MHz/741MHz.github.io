<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>From Switch Statement Down to Machine Code - Ranting @ 741 MHz</title>
  <meta name="author" content="741MHz.com">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://741MHz.com/switch">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Ranting @ 741 MHz" type="application/atom+xml">

  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46193500-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Ranting @ 741 MHz</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li >
                    <a href="/books">Books</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:741MHz.com">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <article class="hentry" role="article">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-01-13T00:00:00-05:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://741MHz.com">Comments</a>
        
      </p>
    
    
    <h1 class="entry-title">
        From Switch Statement Down to Machine Code
        
    </h1>
    
  </header>


<div class="entry-content clearfix"><h2>Introduction</h2>

<p>Most of us know what a <a href="http://en.wikipedia.org/wiki/Switch_statement"><em>switch</em> statement</a> is and have probably been using it very often. No wonder why — switch statement is simple yet extremely expressive. It allows keeping the code compact while describing complex <a href="http://en.wikipedia.org/wiki/Control_flow">control flow</a>. Putting the <a href="http://en.wikipedia.org/wiki/Syntactic_sugar">syntactic sugar</a> aside, most developers also believe that using a switch statement results in a lot better, faster code. Not many knows if that is really true and why. The most common speculations supporting superior switch statement performance are:</p>

<ul>
<li>Compilers implement switch as a <a href="http://en.wikipedia.org/wiki/Branch_table">jump table</a> and it is faster than an average number of conditional branches that the code would have taken otherwise. Therefore, the code generated from switch expressions is executed faster than if-then-else.</li>
<li>Compilers generate a <a href="http://en.wikipedia.org/wiki/Binary_search_algorithm">binary lookup</a> table to match the input value when using switch statement. The binary search algorithm’s worst performance is O(log n). It is a faster than O(n) worst case performance of a <a href="http://en.wikipedia.org/wiki/Linear_search">linear search</a>. Therefore, switch is faster.</li>
</ul>


<p>It all sounds good in theory. Yet not many understand switch statements down to the machine code level and even less have checked what their compilers do. By the way, why cannot a compiler optimize an if-then-else code the same way it optimizes a switch? Maybe it can? Let’s find out!</p>

<p>We’ll use the two most popular production quality compilers — GCC (version 4.7.2, released 20 Sep 2012) and Clang (version 3.0, released December 01, 2011).</p>

<p>In both cases, we will be compiling the code for Intel® Xeon® <a href="http://ark.intel.com/products/47924/Intel-Xeon-Processor-E5630-12M-Cache-2_53-GHz-5_86-GTs-Intel-QPI">E5630</a> CPU with enabled compiler optimizations (either «-O2», «-O3» or «-Os»).</p>

<p>The knowledge of <a href="http://en.wikipedia.org/wiki/X86-64">x86_64</a> <a href="http://en.wikipedia.org/wiki/Assembly_language">assembly language</a> is not required but some understanding of what it is and how CPU process low-level instructions might be helpful.</p>

<h2>Simple Switch</h2>

<p>Let’s start by looking at a very simple switch statement. It has six case labels, does not have a default case, and has no fall-trough cases so each case is followed by a break statement:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">rand</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;three</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;four</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;five</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be logical to assume that the above code would be translated into a jump table. To verify this assumption, we need to disassemble the binary generated by the compiler and check how the machine code looks like.</p>

<p>Below is a disassembly of the binary generated by GCC compiler. Each line has a comment on the right that starts with <code>;</code> character:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mf">4004f</span><span class="mi">7</span><span class="o">:</span>       <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>                    <span class="p">;</span> <span class="n">Compare</span> <span class="n">the</span> <span class="n">value</span> <span class="n">with</span> <span class="mf">5.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">a:</span>       <span class="n">ja</span>     <span class="mi">400518</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span> <span class="k">if</span> <span class="n">the</span> <span class="n">value</span> <span class="n">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="mf">5.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">c:</span>       <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>                    <span class="p">;</span> <span class="n">Clear</span> <span class="mi">32</span> <span class="n">to</span> <span class="mi">63</span> <span class="n">bits</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">e:</span>       <span class="n">xchg</span>   <span class="n">ax</span><span class="p">,</span><span class="n">ax</span>                      <span class="p">;</span> <span class="n">NOP</span>
</span><span class='line'><span class="mi">400500</span><span class="o">:</span>       <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x400738</span><span class="p">]</span> <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">address</span> <span class="mh">0x400738</span><span class="p">[</span><span class="o">%</span><span class="n">rax</span><span class="p">]</span>
</span><span class='line'><span class="mi">400507</span><span class="o">:</span>       <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40072c</span>               <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;five&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">40050</span><span class="nl">c:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">400511</span><span class="o">:</span>       <span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>        <span class="p">;</span> <span class="n">NOP</span>
</span><span class='line'><span class="mi">400518</span><span class="o">:</span>       <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>                    <span class="p">;</span> <span class="n">Zero</span> <span class="k">return</span> <span class="n">code</span><span class="p">.</span>
</span><span class='line'><span class="mi">40051</span><span class="nl">a:</span>       <span class="n">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>                    <span class="p">;</span> <span class="n">Pop</span> <span class="n">stack</span> <span class="p">(</span><span class="n">stack</span> <span class="n">grows</span> <span class="n">inward</span><span class="p">).</span>
</span><span class='line'><span class="mi">40051</span><span class="nl">e:</span>       <span class="n">ret</span>                               <span class="p">;</span> <span class="n">Return</span> <span class="n">from</span> <span class="n">the</span> <span class="n">main</span><span class="p">()</span> <span class="n">function</span><span class="p">.</span>
</span><span class='line'><span class="mf">40051f</span><span class="o">:</span>       <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400727</span>               <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;four&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">400524</span><span class="o">:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">400529</span><span class="o">:</span>       <span class="n">jmp</span>    <span class="mi">400518</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">40052</span><span class="nl">b:</span>       <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400714</span>               <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;three&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">400530</span><span class="o">:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">400535</span><span class="o">:</span>       <span class="n">jmp</span>    <span class="mi">400518</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400537</span><span class="o">:</span>       <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400719</span>               <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;two&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">40053</span><span class="nl">c:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">400541</span><span class="o">:</span>       <span class="n">jmp</span>    <span class="mi">400518</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400543</span><span class="o">:</span>       <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40071d</span>               <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;one&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">400548</span><span class="o">:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">40054</span><span class="nl">d:</span>       <span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="p">]</span>            <span class="p">;</span> <span class="n">NOP</span>
</span><span class='line'><span class="mi">400550</span><span class="o">:</span>       <span class="n">jmp</span>    <span class="mi">400518</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400552</span><span class="o">:</span>       <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400721</span>               <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;zero&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">400557</span><span class="o">:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">40055</span><span class="nl">c:</span>       <span class="n">jmp</span>    <span class="mi">400518</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x38</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">40055</span><span class="nl">e:</span>       <span class="n">xchg</span>   <span class="n">ax</span><span class="p">,</span><span class="n">ax</span>                      <span class="p">;</span> <span class="n">Unreachable</span> <span class="n">NOP</span> <span class="p">(</span><span class="n">padding</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see, GCC has generated the code that uses an indirect jump transferring execution of the program to a code location depending on the input value using a combination of cmp and ja instructions. This is a simple case of a jump table.</p>

<p>To see what other compilers might do, let’s look at the disassembly of the same program compiler by Clang:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mi">4005</span><span class="nl">a7:</span> <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>                     <span class="p">;</span> <span class="n">Compare</span> <span class="n">the</span> <span class="n">value</span> <span class="n">with</span> <span class="mf">5.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">aa:</span> <span class="n">ja</span>     <span class="mf">4005e2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x52</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span> <span class="k">if</span> <span class="n">value</span> <span class="n">is</span> <span class="o">&gt;</span> <span class="mf">5.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ac:</span> <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>                     <span class="p">;</span> <span class="n">Convert</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">to</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="p">(</span><span class="n">clear</span> <span class="n">upper</span> <span class="n">half</span><span class="p">).</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ae:</span> <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x4006e0</span><span class="p">]</span>  <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">a</span> <span class="n">relative</span> <span class="n">address</span> <span class="k">using</span> <span class="o">%</span><span class="n">rax</span> <span class="n">as</span> <span class="n">the</span> <span class="n">index</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">b5:</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400710</span>                <span class="p">;</span> <span class="n">Push</span> <span class="s">&quot;zero&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ba:</span> <span class="n">jmp</span>    <span class="mi">4005</span><span class="n">dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4d</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">bc:</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400715</span>                <span class="p">;</span> <span class="n">Push</span> <span class="s">&quot;one&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">c1:</span> <span class="n">jmp</span>    <span class="mi">4005</span><span class="n">dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4d</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">c3:</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400719</span>                <span class="p">;</span> <span class="n">Push</span> <span class="s">&quot;two&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">c8:</span> <span class="n">jmp</span>    <span class="mi">4005</span><span class="n">dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4d</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ca:</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40071d</span>                <span class="p">;</span> <span class="n">Push</span> <span class="s">&quot;three&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">cf:</span> <span class="n">jmp</span>    <span class="mi">4005</span><span class="n">dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4d</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">d1:</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400723</span>                <span class="p">;</span> <span class="n">Push</span> <span class="s">&quot;four&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">d6:</span> <span class="n">jmp</span>    <span class="mi">4005</span><span class="n">dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4d</span><span class="o">&gt;</span>          <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">d8:</span> <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400728</span>                <span class="p">;</span> <span class="n">Push</span> <span class="s">&quot;five&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">dd:</span> <span class="n">call</span>   <span class="mi">400450</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>           <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span> <span class="p">(</span><span class="n">printing</span> <span class="n">point</span><span class="p">).</span>
</span><span class='line'><span class="mf">4005e2</span><span class="o">:</span> <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>                     <span class="p">;</span> <span class="n">Zero</span> <span class="k">return</span> <span class="p">(</span><span class="n">exit</span> <span class="n">point</span><span class="p">).</span>
</span><span class='line'><span class="mf">4005e4</span><span class="o">:</span> <span class="n">pop</span>    <span class="n">rbp</span>                         <span class="p">;</span> <span class="n">Pop</span> <span class="n">stack</span> <span class="n">frame</span><span class="p">.</span>
</span><span class='line'><span class="mf">4005e5</span><span class="o">:</span> <span class="n">ret</span>                                <span class="p">;</span> <span class="n">Return</span>
</span><span class='line'><span class="mf">4005e6</span><span class="o">:</span> <span class="n">nop</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="nl">cs:</span><span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span> <span class="p">;</span> <span class="n">NOP</span> <span class="p">(</span><span class="n">alignment</span><span class="o">/</span><span class="n">padding</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>From the above example, we can immediately tell that Clang has generated a more compact code by avoiding multiple calls to puts() function.</p>

<p>Interestingly enough, GCC can also eliminate multiple calls to puts() function and generate exactly the same code for the above switch statement as Clang does. To achieve this, we must specify «-Os» flag on the command line. This flags instructs the compiler to optimize the binary for small size.</p>

<p>Apart from this small difference in optimizing function calls, both compilers used a combination of cmp and ja functions to implement a jump table. From this we can draw a conclusion that for simple cases compilers do generate a jump table.</p>

<h2>Crafting a Jump Table</h2>

<p>To get a better understanding of a jump table mechanics, let’s consider creating one manually without using a switch statement. It is possible to create a jump table manually a few different ways.</p>

<p>The first way of writing a jump table is to use an assembler language. It is low level programming language that does not have high-level constructs such as if-then-else or switch, but it allows to use processor instructions directly, making it possible to manually employ “cmp”, “ja” or other instructions to implement a functional equivalent of the code generated by compilers. This would have been very time consuming, require much higher understanding of the assembly language, result in less portable and hard to maintain code.</p>

<p>It is also possible to code a logical equivalent of a jump table in C, without using a switch statement. To do this, we could create an array that holds function pointers, and then call a function using an index to this array. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">zero</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;zero&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">one</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;one&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">two</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;two&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="err"> </span>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">func</span> <span class="n">table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">two</span> <span class="p">};</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* Read the value of `i` from user</span>
</span><span class='line'><span class="cm">       input or other source */</span>
</span><span class='line'>    <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This, however, would only be a logical equivalent of the jump table, but not a functional one. The main difference in functionality is that jump table transfers control to a specified location directly instead of calling a function.
To achieve a functional equivalent of the jump table in C or C++, we must structure the code in such a way as to avoid function calls. We must create an array of addresses where the control is to be transferred, instead of array of functions. One of the possible ways of doing this is to label our code and create an array that store labels instead of functions. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">jump_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="o">&amp;&amp;</span><span class="n">print_0</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">print_1</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">print_2</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;&amp;</span><span class="n">print_3</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">print_4</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">print_5</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>        <span class="n">v</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>        <span class="k">goto</span> <span class="o">*</span><span class="n">jump_table</span><span class="p">[</span><span class="n">v</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">print_0:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="nl">print_1:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="nl">print_2:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="nl">print_3:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;three</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="nl">print_4:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;four</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="nl">print_5:</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;five</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'><span class="nl">out:</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code would result in exactly the same binary as produced by GCC for a simple switch statement example we have reviewed in the first chapter. It cannot be considered readable or easily maintainable, but it could have been used for performance reasons if C or C++ language did not have a switch statement construct.</p>

<p>Note that despite being used by low-level developers from time to time, the above code is not standard. It is neither standard C nor C++ is none of those languages support taking address of a label. Despite that, this feature is implemented as a nonstandard extension by most production grade C and C++ compilers.</p>

<h2>Trivial Switch</h2>

<p>Modern processors employ a wide variety of optimization techniques to speed up the execution of computer programs. One of those techniques is branch prediction. It tries to guess which way a branch of the logic will go before this is known for sure. In a high-level programming languages such as C, branches are formed by if-then-else structures, goto instructions, different kinds of loop statements, switch statement and other constructs.</p>

<p>How processors implement branch prediction is largely a trade secret. It is well known, however, that this technique is less efficient if processor runs into indirect branch instruction, such as that used in jump tables code. In other words, a single indirect jump instruction is relatively more expensive than a simple branch, such as generated by if-then construct.</p>

<p>This means that for some architectures, it is possible that a simple if-then-else statement with a few comparisons and direct jump instructions might theoretically execute faster than a single indirect jump instruction. In other words, if compilers always generate a jump table for a switch statement, then we could write a more efficient code (from execution time perspective) by avoiding using a switch and resorting to if-then-else.</p>

<p>The cost ratio of compare and jump instructions to indirect jump instruction is not known without experimentation. How much if-then-else branches can we take before its execution time would be slower than that of a single indirect jump? It is also not clear whether compilers take care of this or not. To find out, we must experiment. Since our initial switch statement had six case labels, we must keep reducing the number of labels, disassemble the resulting binary on every stage and compare the results to see if the generated code is functionally different.</p>

<h3>Five Cases</h3>

<p>The first step is to remove a single label from the switch, effectively reducing a number of case labels to five. By doing so, nothing has changed regarding how compilers handle switch statement in case with both GCC and Clang compilers.</p>

<h3>Four Cases</h3>

<p>Reducing a number of cases further results in some interesting changes. With only four cases in a switch, Clang continues to generate a jump table as in all previous cases. GCC, on the other hand, stops using a jump table and resorts to simple comparison equivalent to if-then-else. Below is a disassembled binary demonstrating what GCC does in this case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mf">4004f</span><span class="mi">4</span><span class="o">:</span>  <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1</span>             <span class="p">;</span> <span class="n">Compare</span> <span class="n">value</span> <span class="n">with</span> <span class="mf">1.</span>
</span><span class='line'><span class="mf">4004f</span><span class="mi">7</span><span class="o">:</span>  <span class="n">je</span>     <span class="mi">400514</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x34</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">If</span> <span class="n">value</span> <span class="n">is</span> <span class="mi">1</span><span class="p">,</span> <span class="n">go</span> <span class="n">there</span>
</span><span class='line'><span class="mf">4004f</span><span class="mi">9</span><span class="o">:</span>  <span class="n">jg</span>     <span class="mi">400501</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x21</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">If</span> <span class="n">value</span> <span class="n">is</span> <span class="n">greater</span> <span class="n">than</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compare</span> <span class="n">more</span><span class="p">.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">b:</span>  <span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>             <span class="p">;</span> <span class="n">Could</span> <span class="n">be</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mf">0.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">d:</span>  <span class="n">je</span>     <span class="mi">40050</span><span class="n">d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x2d</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Go</span> <span class="n">ptint</span> <span class="s">&quot;zero&quot;</span> <span class="k">if</span> <span class="n">matched</span> <span class="n">or</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">exit</span>
</span><span class='line'><span class="mf">4004ff</span><span class="o">:</span>  <span class="n">jmp</span>    <span class="mi">40052</span><span class="n">c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4c</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Jump</span> <span class="n">to</span> <span class="n">exit</span> <span class="p">(</span><span class="n">value</span> <span class="n">was</span> <span class="n">not</span> <span class="n">zero</span><span class="p">)</span>
</span><span class='line'><span class="mi">400501</span><span class="o">:</span>  <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x2</span>             <span class="p">;</span> <span class="n">Value</span> <span class="n">was</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="n">Compare</span> <span class="n">it</span> <span class="n">with</span> <span class="mf">2.</span>
</span><span class='line'><span class="mi">400504</span><span class="o">:</span>  <span class="n">je</span>     <span class="mi">40051</span><span class="n">b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x3b</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Matched</span><span class="p">,</span> <span class="n">go</span> <span class="n">print</span> <span class="n">and</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400506</span><span class="o">:</span>  <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x3</span>             <span class="p">;</span> <span class="n">Was</span> <span class="o">!=</span> <span class="mf">2.</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mf">3.</span>
</span><span class='line'><span class="mi">400509</span><span class="o">:</span>  <span class="n">jne</span>    <span class="mi">40052</span><span class="n">c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4c</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">exit</span> <span class="k">if</span> <span class="n">not</span> <span class="n">matched</span><span class="p">.</span>
</span><span class='line'><span class="mi">40050</span><span class="nl">b:</span>  <span class="n">jmp</span>    <span class="mi">400522</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x42</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Value</span> <span class="n">is</span> <span class="n">three</span><span class="o">!!!</span> <span class="n">Go</span> <span class="n">print</span> <span class="n">it</span><span class="p">.</span>
</span><span class='line'><span class="mi">40050</span><span class="nl">d:</span>  <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4006e4</span>        <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;zero&quot;</span> <span class="n">as</span> <span class="n">parameter</span><span class="p">.</span>
</span><span class='line'><span class="mi">400512</span><span class="o">:</span>  <span class="n">jmp</span>    <span class="mi">400527</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x47</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Go</span> <span class="n">call</span> <span class="s">&quot;puts()&quot;</span> <span class="n">and</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400514</span><span class="o">:</span>  <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4006e9</span>        <span class="p">;</span> <span class="n">End</span> <span class="n">up</span> <span class="n">here</span> <span class="k">if</span> <span class="n">value</span> <span class="n">is</span> <span class="mf">1.</span>
</span><span class='line'><span class="mi">400519</span><span class="o">:</span>  <span class="n">jmp</span>    <span class="mi">400527</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x47</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Go</span> <span class="n">call</span> <span class="s">&quot;puts()&quot;</span> <span class="n">and</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">40051</span><span class="nl">b:</span>  <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4006ed</span>        <span class="p">;</span> <span class="n">Value</span> <span class="n">was</span> <span class="mf">2.</span> <span class="n">Set</span><span class="p">...</span>
</span><span class='line'><span class="mi">400520</span><span class="o">:</span>  <span class="n">jmp</span>    <span class="mi">400527</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x47</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="p">...</span> <span class="s">&quot;two&quot;</span> <span class="n">as</span> <span class="n">parameter</span> <span class="n">and</span> <span class="n">go</span> <span class="n">print</span><span class="p">.</span>
</span><span class='line'><span class="mi">400522</span><span class="o">:</span>  <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x4006f1</span>        <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;three&quot;</span> <span class="n">as</span> <span class="n">argument</span> <span class="n">to</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">400527</span><span class="o">:</span>  <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>   <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">40052</span><span class="nl">c:</span>  <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>             <span class="p">;</span> <span class="n">Zero</span> <span class="k">register</span> <span class="n">with</span> <span class="k">return</span> <span class="n">value</span><span class="p">.</span>
</span><span class='line'><span class="mi">40052</span><span class="nl">e:</span>  <span class="n">pop</span>    <span class="n">rdx</span>                 <span class="p">;</span> <span class="n">Pop</span> <span class="n">stack</span>
</span><span class='line'><span class="mf">40052f</span><span class="o">:</span>  <span class="n">ret</span>                        <span class="p">;</span> <span class="n">Return</span> <span class="n">control</span> <span class="n">to</span> <span class="n">the</span> <span class="n">caller</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see, there is no longer an indirect jump. Instead, the input is compared with every possible value using a set of compare and jump instructions.</p>

<h3>Three and Less Cases</h3>

<p>With only three cases in a switch, Clang starts generating the same code as GCC does starting at four — comparison instructions are used instead of a jump table.
By reducing a number of cases further down to one, the same result is observed with both compilers.</p>

<h3>Note on GCC</h3>

<p>GCC compiler allows users to control the cutoff between doing switch statements as a series of if-then-else statements and using a jump table since version 4.7. The threshold controlling this behavior can be specified as a command line option.</p>

<h3>Conclusion</h3>

<p>From the above experiments, we can conclude that both GCC and Clang compilers are well aware that indirect jumps are relatively expensive.</p>

<p>Both compilers are trying to avoid a jump table if the number of case labels in the switch is small enough to justify using a chain of compare and jump instructions.</p>

<p>The only difference between the two compilers is they use a different cost ratio when deciding on using a jump table. GCC drops the idea of jump table starting at 4 case labels down to 1. Clang drops the jump table approach at 3 swithc cases and below.</p>

<p>This of course is purely an implementation detail and can change from one platform to another, or between different versions of the compiler.</p>

<h2>Default Case</h2>

<p>Does having a switch statement with a default case affect the mechanism used to implement a switch statement in machine code?</p>

<p>Unlike hardware description languages like Verilog where there could be no default case in a switch, the software logic always has a default case that transfers a control flow further. It might be explicitly specified with a special default case label, or be implicitly generated by a compiler.</p>

<p>Therefore, the presence or absence of an explicit default case does not make a difference. The only case when not specifying a default case explicitly is beneficial is when switch is performed on enumeration. In that case, compiler may warn a programmer if switch does not handle all possible values of enumeration. This is strictly a static analysis feature that is helpful to developers but does not affect compiler’s decision about the implementation mechanism of a switch statement in any way.</p>

<h2>Large Values</h2>

<p>Not all switch cases have their values starting at 0. Some may have them start at one, two or even a million. Since jump tables are essentially represented as arrays, and all arrays in both C and C++ languages start with 0. We certainly cannot create an array of 101 elements only to have the last entry at index 100 to hold a valid jump address. So how does having large values in the switch affect the generated code?</p>

<h3>Continuous Range</h3>

<p>Let’s first take a look at a very simple example where all case values of a switch are continues:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">rand</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1986000</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1986001</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1986002</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1986003</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;three</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1986004</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;four</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1986005</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;five</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the minimum value in the switch is 198,600,000. Some programmers think that, because compiler build a jump table from case values and the input to a switch statement might be used as an index to a jump table, having large values will not work and result in less efficient code. So what they are trying to help the compiler optimize the code by writing it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1986000</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;three</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;four</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;five</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In other words, they subtract N from input value to make the resulting range start from 0. Is this a good optimization?</p>

<p>Both GCC and Clang are production grade compilers. It is extremely rare to run into a situation where programmer needs to optimize such a simple case manually, unless programmer knows something that compiler cannot possibly guess from context. Therefore, it would be logical to assume that both GCC and Clang should handle the above optimization automatically. To verify this, below is a disassembled binary code generated by GCC from the code without a manual optimization:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mf">4004f</span><span class="mi">2</span><span class="o">:</span>       <span class="n">call</span>   <span class="mi">4004</span><span class="n">d0</span> <span class="o">&lt;</span><span class="n">rand</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;rand()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mf">4004f</span><span class="mi">7</span><span class="o">:</span>       <span class="n">sub</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1e4dd0</span>      <span class="p">;</span> <span class="n">Subtract</span> <span class="s">&quot;1986000&quot;</span> <span class="n">from</span> <span class="n">the</span> <span class="n">result</span><span class="p">.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">c:</span>       <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>           <span class="p">;</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mi">5</span> <span class="n">and</span> <span class="k">do</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">as</span> <span class="n">before</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code generated by the Clang looks exactly the same:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mi">4005</span><span class="nl">a2:</span>       <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">rand</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;rand()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">a7:</span>       <span class="n">add</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0xffe1b230</span>    <span class="p">;</span> <span class="n">Add</span> <span class="s">&quot;4292981296&quot;</span> <span class="n">to</span> <span class="n">the</span> <span class="n">result</span><span class="p">.</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ac:</span>       <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>           <span class="p">;</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mi">5</span> <span class="n">and</span> <span class="k">do</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">as</span> <span class="n">before</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>This proves that compilers are smart enough to perform basic optimization on switch statements whose values are not starting with 0.</p>

<h3>Sparse Values</h3>

<p>So far we have looked at simple switch statements whose case values were continuous. They either started from 0 or other numbers and incremented continuously without gaps in between.</p>

<p>The Wikipedia article on switch statement quotes a research paper:</p>

<blockquote><p>To optimize a switch statement, the programmer must use a very compact range of possible values to test.</p></blockquote>

<p>What happens if that is not possible or if programmer does something differently? Does it mean that a switch statement would not be optimized in any way?</p>

<p>There are two common types of values distribution in sparse switches. The first is when values can still be grouped together. For example, values of 10, 11, 12, 100 and 101 can grouped into two compact ranges, [10-12] and [100-101]. The second case is when no grouping can be done whatsoever.</p>

<p>Let’s test those two cases and find out what optimizations are performed by the compiler, if any.</p>

<h4>Distant Ranges</h4>

<p>Consider the following switch statement with values in [0-5] and [10000-10002] ranges:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">rand</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;three</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;four</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;five</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10000</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10001</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10002</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;10K!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is the disassembled binary code generated for the above code by GCC:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mf">4004f</span><span class="mi">7</span><span class="o">:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x3</span>             <span class="p">;</span> <span class="n">Comparison</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mf">3.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">a:</span>   <span class="n">je</span>     <span class="mi">40056</span><span class="n">e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x8e</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">It</span> <span class="n">is</span> <span class="mi">3</span><span class="o">!</span> <span class="n">Print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">c:</span>   <span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
</span><span class='line'><span class="mi">400500</span><span class="o">:</span>   <span class="n">jle</span>    <span class="mf">40051f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x3f</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Is</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">?</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">comparison</span> <span class="err">#</span><span class="mf">3.</span>
</span><span class='line'><span class="mi">400502</span><span class="o">:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>             <span class="p">;</span> <span class="n">Comparison</span> <span class="err">#</span><span class="mi">2</span><span class="o">:</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mf">4.</span>
</span><span class='line'><span class="mi">400505</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">400553</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x73</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">It</span> <span class="n">is</span> <span class="mi">4</span><span class="o">!</span> <span class="n">Print</span> <span class="o">&amp;</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400507</span><span class="o">:</span>   <span class="n">jl</span>     <span class="mi">400537</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x57</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Is</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">?</span> <span class="n">Goto</span> <span class="n">comparison</span> <span class="err">#</span><span class="mf">4.</span>
</span><span class='line'><span class="mi">400509</span><span class="o">:</span>   <span class="n">sub</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x2710</span>          <span class="p">;</span> <span class="n">Subtract</span> <span class="mf">10000.</span>
</span><span class='line'><span class="mi">40050</span><span class="nl">e:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x2</span>             <span class="p">;</span> <span class="n">Comparison</span> <span class="err">#</span><span class="mi">5</span><span class="o">:</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mf">2.</span>
</span><span class='line'><span class="mi">400511</span><span class="o">:</span>   <span class="n">ja</span>     <span class="mi">400530</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x50</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">It</span> <span class="n">is</span> <span class="o">&gt;</span><span class="mf">2.</span> <span class="n">Just</span> <span class="n">exit</span> <span class="p">(</span><span class="n">no</span> <span class="n">match</span><span class="p">).</span>
</span><span class='line'><span class="mi">400513</span><span class="o">:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400741</span>        <span class="p">;</span> <span class="n">Set</span> <span class="s">&quot;10K!&quot;</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span>
</span><span class='line'><span class="mi">400518</span><span class="o">:</span>   <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>   <span class="p">;</span> <span class="n">Call</span> <span class="s">&quot;puts()&quot;</span><span class="p">.</span>
</span><span class='line'><span class="mi">40051</span><span class="nl">d:</span>   <span class="n">jmp</span>    <span class="mi">400530</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x50</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mf">40051f</span><span class="o">:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1</span>             <span class="p">;</span> <span class="n">Comparison</span> <span class="err">#</span><span class="mi">3</span><span class="o">:</span> <span class="n">Compare</span> <span class="n">with</span> <span class="mf">1.</span>
</span><span class='line'><span class="mi">400522</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">400562</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x82</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">It</span> <span class="n">is</span> <span class="mi">1</span><span class="o">!</span> <span class="n">Go</span> <span class="n">print</span> <span class="n">it</span><span class="p">.</span>
</span><span class='line'><span class="mi">400524</span><span class="o">:</span>   <span class="n">jle</span>    <span class="mi">400543</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x63</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">It</span> <span class="n">is</span> <span class="n">less</span> <span class="n">than</span> <span class="mf">1.</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">comparison</span> <span class="err">#</span><span class="mf">6.</span>
</span><span class='line'><span class="mi">400526</span><span class="o">:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40072d</span>        <span class="p">;</span> <span class="n">The</span> <span class="n">value</span> <span class="n">is</span> <span class="mi">2</span> <span class="p">(</span><span class="n">by</span> <span class="n">exclusion</span><span class="p">),</span>
</span><span class='line'><span class="mi">40052</span><span class="nl">b:</span>   <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>   <span class="p">;</span> <span class="p">...</span> <span class="n">print</span> <span class="s">&quot;2&quot;</span> <span class="n">and</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400530</span><span class="o">:</span>   <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
</span><span class='line'><span class="mi">400532</span><span class="o">:</span>   <span class="n">add</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x8</span>
</span><span class='line'><span class="mi">400536</span><span class="o">:</span>   <span class="n">ret</span>
</span><span class='line'><span class="mi">400537</span><span class="o">:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400737</span>
</span><span class='line'><span class="mi">40053</span><span class="nl">c:</span>   <span class="n">call</span>   <span class="mi">400490</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">400541</span><span class="o">:</span>   <span class="n">jmp</span>    <span class="mi">400530</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x50</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">400543</span><span class="o">:</span>   <span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>             <span class="p">;</span> <span class="n">Comparison</span> <span class="err">#</span><span class="mi">6</span>
</span><span class='line'><span class="mi">400545</span><span class="o">:</span>   <span class="n">jne</span>    <span class="mi">400530</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x50</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">Nope</span><span class="p">.</span> <span class="n">No</span> <span class="n">match</span> <span class="n">here</span><span class="p">.</span> <span class="n">Go</span> <span class="n">to</span> <span class="n">exit</span><span class="p">.</span>
</span><span class='line'><span class="mi">400547</span><span class="o">:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400724</span>        <span class="p">;</span> <span class="n">Print</span> <span class="s">&quot;zero&quot;</span> <span class="n">and</span> <span class="n">exit</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see, the generated code seems to be less efficient compared to that of jump table. By looking closer at the program flow we can see that GCC has implemented a binary search algorithm. It is still well optimized compared to a simple chain of compare and jump instructions generated by if-then-else.</p>

<p>Clang takes a different approach in handling the above code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mi">4005</span><span class="nl">a7:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x270f</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ac:</span>   <span class="n">jg</span>     <span class="mf">4005e6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x56</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ae:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">b1:</span>   <span class="n">ja</span>     <span class="mf">4005f</span><span class="n">b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x6b</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">b3:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">b5:</span>   <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x4006f0</span><span class="p">]</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">bc:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400720</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">c1:</span>   <span class="n">jmp</span>    <span class="mf">4005f</span><span class="mi">6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x66</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">c3:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400725</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">c8:</span>   <span class="n">jmp</span>    <span class="mf">4005f</span><span class="mi">6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x66</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ca:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400729</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">cf:</span>   <span class="n">jmp</span>    <span class="mf">4005f</span><span class="mi">6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x66</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">d1:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40072d</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">d6:</span>   <span class="n">jmp</span>    <span class="mf">4005f</span><span class="mi">6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x66</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">d8:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400733</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">dd:</span>   <span class="n">jmp</span>    <span class="mf">4005f</span><span class="mi">6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x66</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">df:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x400738</span>
</span><span class='line'><span class="mf">4005e4</span><span class="o">:</span>   <span class="n">jmp</span>    <span class="mf">4005f</span><span class="mi">6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x66</span><span class="o">&gt;</span>
</span><span class='line'><span class="mf">4005e6</span><span class="o">:</span>   <span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">rax</span><span class="o">-</span><span class="mh">0x2710</span><span class="p">]</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ec:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x3</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ef:</span>   <span class="n">jae</span>    <span class="mf">4005f</span><span class="n">b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x6b</span><span class="o">&gt;</span>
</span><span class='line'><span class="mf">4005f</span><span class="mi">1</span><span class="o">:</span>   <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="mh">0x40073d</span>
</span><span class='line'><span class="mf">4005f</span><span class="mi">6</span><span class="o">:</span>   <span class="n">call</span>   <span class="mi">400450</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</span><span class='line'><span class="mf">4005f</span><span class="nl">b:</span>   <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
</span><span class='line'><span class="mf">4005f</span><span class="nl">d:</span>   <span class="n">pop</span>    <span class="n">rbp</span>
</span><span class='line'><span class="mf">4005f</span><span class="nl">e:</span>   <span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code generated by Clang is a little bit more tricky compared to GCC. First it compares the input value with 9999. If the value is greater, it normalizes it by subtracting 10000 using “lea“ instruction, and then checks if the value is within [0-3) range. If it is, the “10K” is then printed. Otherwise, the function returns. If value is less than 9999, it ensures the value is in [0-5] range and uses a jump table. Very clever, isn’t it?</p>

<h4>Sparse Values</h4>

<p>The second common switch pattern is when values are sparse enough so that they cannot be grouped together. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">rand</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">50</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;50!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">100</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;100!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">150</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;150!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">200</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;200!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">250</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;250!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">300</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Spartans!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">350</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;350!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">400</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;400!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">450</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;400!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">500</span><span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;400!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10000</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10001</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10002</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10003</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10004</span><span class="o">:</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">10005</span><span class="o">:</span>
</span><span class='line'>          <span class="n">printf</span><span class="p">(</span><span class="s">&quot;10K!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the above code, both GCC and Clang compilers have generated a binary search algorithm.
Changing the order of case labels in the switch did not affect the generated code — both compilers have analyzed all the specified values before making optimization decisions.</p>

<h2>Fall Through Switch</h2>

<p>So far we have looked at switch statements with no fall through cases, where each case had a trivial code. There are of course more complex scenarios.</p>

<p>What happens if we introduce fall through switch? What if we make each case statement to have complex control flows? What if we do both of the above?</p>

<p>The answer is simple — it does not fundamentally change the way compilers implement switch statements. The same approach of mixing comparison, range checking, binary search and jump table logic is still used.</p>

<p>What it affects, however, is how compiler rearranges the control flow. It may group some logic together, or split it. Redundant code might be reduced, or it might get duplicated intentionally to reduce a number of jump instructions. The code might be placed at different addresses, compiler might also generate different jump instructions to achieve the most compact and fast code. All those optimizations techniques are not unique to switch statements and are being used with other language constructs.</p>

<h2>Outsmarting Compilers</h2>

<p>Every discussion about code micro-optimization, which switch statements are usually part of, shall start with a word of warning. Outsmarting a production quality compiler these days is a nearly impossible task. A programmer should not even try to optimize the code that is not proven to be a bottleneck by carefully profiling the whole program. If a piece of code is proven to be slow and there is an obvious optimization that compiler has failed to perform, shop for a better compiler. Start by optimizing the logic and not the code — doing less steps where possible, avoiding chaotic dynamic memory manipulations, using well designed data structures will pay off more than any micro-optimization.</p>

<p>If, however, a switch statement turns out to be one of the biggest bottlenecks of the code, there might be ways to improve it. To do that, it is vital to know more information about the possible values passed into a switch than compiler knows about or may figure out from context. If there is nothing known about the input value — don’t bother optimizing, there is no way of implementing a general case better than a compiler.</p>

<h3>Improving a Switch</h3>

<p>Consider the following example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>      <span class="n">do_very_important_stuff_0</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>      <span class="n">do_not_important_stuff_1</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>      <span class="n">do_not_important_stuff_2</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>      <span class="n">do_not_important_stuff_3</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>      <span class="n">do_not_important_stuff_4</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span><span class='line'>      <span class="n">do_very_important_stuff_5</span><span class="p">();</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above switch statement will be implemented using a jump table. It is impossible to do better unless it is known that most of the time the value is either 0 or 5, and can turn out to be 1, 2 or 3 only in some rare conditions that almost never happen. If that is the case, there is no way that compiler may know about it (unless of course we use profiler feedback optimization, which is not always possible). So how to optimize this for that particular case?</p>

<p>We remember that an indirect call is more expensive than two-three comparisons, at least for our given platform. This was proven during our earlier experiments with reducing a number of cases in a switch. Given that our critical path in the above examples consists of only two values — 0 and 5, the code can be optimized by not using those two statements in a switch case to avoid an expensive indirect jump. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">do_very_important_stuff_0</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">do_very_important_stuff_5</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>          <span class="n">do_not_important_stuff_1</span><span class="p">();</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>          <span class="n">do_not_important_stuff_2</span><span class="p">();</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>          <span class="n">do_not_important_stuff_3</span><span class="p">();</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>          <span class="n">do_not_important_stuff_4</span><span class="p">();</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If there are only two or three possible input values, the same technique can be used to improve switch statements that compiler implements using a binary search approach. If, however, the input value may vary, improving a switch performance turns into nothing more but improving a search algorithm. The programmer will have to analyze the most common set of input values, select or invent the search algorithm with better average performance or better performance for more important inputs, and manually implement the switch functionality using handcrafted if-then-else statements, creating a jump table manually (as described in chapter 3), or both.</p>

<h3>Switch vs High-Level Search</h3>

<p>Some developers occasionally get concerned whether it is better to use a switch statement or a higher-level search algorithms like, for example, a hash lookup implemented by the std::unordered_map class from C++ Standard Library.</p>

<h4>Hash Lookup</h4>

<p>Compared to dynamic hash lookup tables, statically generated lookup code for a pre-defined ranges of values will always be better than any other hash table implementation given that switch statements can only work with constant simple numeric POD types.</p>

<h4>Binary Search</h4>

<p>Ordered lookup algorithms such as those commonly used with std::map can theoretically be more efficient than a switch statement. The runtime overhead of those algorithms, however, may render them useless compared to a simple, low-level switch implementation. This may also depend on a nature of the input. Therefore, there is no general answer to this question and developers must test both implementations to determine which one is better in any particular case.</p>

<h2>If-then-else Recognition</h2>

<p>By experimenting with different switch statements we have ensured that compilers do a wonderful optimization job. It almost does not matter how programmers describe the switch it in the code — compiler will always generate nearly perfect generic lookup algorithms, rearrange code as needed, group or duplicate statements and apply other techniques to make the code most efficient.</p>

<p>C programming language is very high-level and it might seem that in many cases it should not matter how the control flow is described and the same optimization might be applied as long as a resulting program is functionally the same. This raises a question of whether compiler will do the same optimizations if programmer is using if-then-else. In theory, it might be the same, or might be different. But instead of guessing, let’s find out.</p>

<p>Below is a C program that is equivalent to our simple switch example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;two</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;three</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;four</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;five</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>GCC did not generate an equivalent code to that of a switch statement. A set of compare instructions is used instead. Here is a relevant snippet of the binary code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mf">4004f</span><span class="mi">7</span><span class="o">:</span>   <span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
</span><span class='line'><span class="mf">4004f</span><span class="mi">9</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">40051</span><span class="n">e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x3e</span><span class="o">&gt;</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">b:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1</span>
</span><span class='line'><span class="mf">4004f</span><span class="nl">e:</span>   <span class="n">xchg</span>   <span class="n">ax</span><span class="p">,</span><span class="n">ax</span>
</span><span class='line'><span class="mi">400500</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">400536</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x56</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">400502</span><span class="o">:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x2</span>
</span><span class='line'><span class="mi">400505</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">400542</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x62</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">400507</span><span class="o">:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x3</span>
</span><span class='line'><span class="mi">40050</span><span class="nl">a:</span>   <span class="n">je</span>     <span class="mi">40054</span><span class="n">e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x6e</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">40050</span><span class="nl">c:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span>
</span><span class='line'><span class="mf">40050f</span><span class="o">:</span>   <span class="n">nop</span>
</span><span class='line'><span class="mi">400510</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">40055</span><span class="n">a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x7a</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">400512</span><span class="o">:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>
</span><span class='line'><span class="mi">400515</span><span class="o">:</span>   <span class="n">je</span>     <span class="mi">40052</span><span class="n">a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x4a</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Clang compiler, on the other hand, has generated a jump table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="mi">4005</span><span class="nl">a7:</span>   <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x5</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">aa:</span>   <span class="n">ja</span>     <span class="mf">4005e2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x52</span><span class="o">&gt;</span>
</span><span class='line'><span class="mi">4005</span><span class="nl">ae:</span>   <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x4006e0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Therefore, we can draw a conclusion that compilers can and sometimes do optimize if-then-else statements the same way they optimize switch statements.</p>

<p>Whether it makes sense or not is another question. At first, it may seem like Clang has done a lot better job than GCC. However, this automatically prevents developer from performing optimizations described in the previous chapter by making it impossible to use comparison in the fast path of the program. This also prevents developers from manually providing branch prediction hints because switch cases, unlike if-then-else branches, cannot be explicitly prioritized. Since compilers cannot know for sure if switch was replaced by if-then-else statement on purpose, automatically replacing if-then-else with switch might discard programmer’s optimization efforts and worsen the runtime efficiency of the program.</p>

<h2>Summary</h2>

<p>We have learned how decent compilers transform higher-level switch statements into a low level machine code, reviewed a number of different examples along with optimization techniques applied by the compilers.</p>

<p>We also discussed a few optimization techniques that can be applied in certain situations to improve the application performance by using a special mix of switch and if-then-else statements.</p>

<p>I hope that it would helps us, developers, to better understand what switch statements are, what they can be used for and how they work, as well as adding some practical backup to some very common speculative talks about switch statement optimizations.</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard">Posted by <span class="fn">741MHz.com</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-01-13T00:00:00-05:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/c-plus-plus/'>C++</a> <a class='category label label-primary' href='/blog/categories/tech/'>Tech</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://741MHz.com/switch/" data-via="" data-counturl="http://741MHz.com/switch/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/unreasonable-effectiveness-of-c/" title="Previous Post: Unreasonable Effectiveness of C">&laquo; Unreasonable Effectiveness of C</a></li>
            
            
            <li class="next"><a href="/vector-erase/" title="Next Post: Erasing Vector The Smart Way">Erasing Vector The Smart Way &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/smart-getopt/">Smart Command Line Options Parsing</a>
    
    <a class="list-group-item " href="/range-for/">Range-Based for Loop</a>
    
    <a class="list-group-item " href="/inheriting-constructors/">Inheriting Constructors in C++11</a>
    
    <a class="list-group-item " href="/default-function-template-arguments/">Default Template Arguments for Functions</a>
    
    <a class="list-group-item " href="/auto-type/">Automatic Type Deduction With 'Auto' Keyword</a>
    
    <a class="list-group-item " href="/decltype/">Type of Expression in C++</a>
    
    <a class="list-group-item " href="/delegating-constructors/">Delegating Constructors in C++11</a>
    
    <a class="list-group-item " href="/member-initializers/">Non-Static Data Member Initializers</a>
    
    <a class="list-group-item " href="/right-angle-brackets/">C++ and Right Angle Brackets</a>
    
    <a class="list-group-item " href="/static-assert/">Static Assert</a>
    
  </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Categories</h3>
  </div>
  <div class="list-group">
    
    
    <a class="list-group-item " href="/blog/categories/c-plus-plus">
        <span class="badge">26</span>
        C++
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/linux">
        <span class="badge">3</span>
        Linux
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/tech">
        <span class="badge">34</span>
        Tech
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/c-plus-plus-11">
        <span class="badge">10</span>
        C++11
      </a>
    
    
    <a class="list-group-item " href="/blog/categories/life">
        <span class="badge">2</span>
        Life
      </a>
    
  </div>
</section>




<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Tower -->
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-1385230165688960"
     data-ad-slot="6630198999"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2010-2013 <a href="/">741MHz.com</a>
</p>

</div>
</footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


<script type="text/javascript">
      var disqus_shortname = '741mhz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://741MHz.com/switch/';
        var disqus_url = 'http://741MHz.com/switch/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </body>
</html>
